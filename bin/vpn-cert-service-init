#!/usr/bin/php
<?php

require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\VPN\EasyRsa;
use fkooman\Config\Config;

$config = Config::fromIniFile(
    dirname(__DIR__)."/config/config.ini"
);

$easyRsaPath = '/usr/share/easy-rsa/2.0';
$easyRsaTargetConfigPath = $config->getValue('easyRsaConfigPath', true);

if (!file_exists($easyRsaTargetConfigPath)) {
    mkdir($easyRsaTargetConfigPath);
}
foreach (glob($easyRsaPath."/*") as $file) {
    $fp = fileperms($file);
    copy($file, $easyRsaTargetConfigPath."/".basename($file));
    // also keep file permissions
    chmod($easyRsaTargetConfigPath."/".basename($file), $fp);
}
# update configuration in "vars"
//export KEY_EXPIRE=3650

$e = new EasyRsa($easyRsaTargetConfigPath);
$e->cleanAll();
$e->initCa();
$e->generateServerCert("s3rv3r");
