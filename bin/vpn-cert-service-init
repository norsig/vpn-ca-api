#!/usr/bin/php
<?php

require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\VPN\EasyRsa;
use fkooman\Config\Config;
use fkooman\VPN\PdoStorage;

$config = Config::fromIniFile(
    dirname(__DIR__)."/config/config.ini"
);

$easyRsaPath = '/usr/share/easy-rsa/2.0';
$easyRsaTargetConfigPath = $config->getValue('easyRsaConfigPath', true);

if (!file_exists($easyRsaTargetConfigPath)) {
    mkdir($easyRsaTargetConfigPath);
}
foreach (glob($easyRsaPath."/*") as $file) {
    $fp = fileperms($file);
    copy($file, $easyRsaTargetConfigPath."/".basename($file));
    // also keep file permissions
    chmod($easyRsaTargetConfigPath."/".basename($file), $fp);
}

$caConfig = $config->s('ca')->l('ca_expire');

# update the 'vars' file
$search = array(
    'export CA_EXPIRE=3650',
    'export KEY_EXPIRE=3650',
    'export KEY_COUNTRY="US"',
    'export KEY_PROVINCE="CA"',
    'export KEY_CITY="SanFrancisco"',
    'export KEY_ORG="Fort-Funston"',
    'export KEY_EMAIL="me@myhost.mydomain"',
    'export KEY_OU="MyOrganizationalUnit"',
);
$replace = array(
    sprintf('export CA_EXPIRE=%d', $config->s('ca', true)->l('ca_expire', true)),
    sprintf('export KEY_EXPIRE=%d', $config->s('ca', true)->l('key_expire', true)),
    sprintf('export KEY_COUNTRY="%s"', $config->s('ca', true)->l('key_country', true)),
    sprintf('export KEY_PROVINCE="%s"', $config->s('ca', true)->l('key_province', true)),
    sprintf('export KEY_CITY="%s"', $config->s('ca', true)->l('key_city', true)),
    sprintf('export KEY_ORG="%s"', $config->s('ca', true)->l('key_org', true)),
    sprintf('export KEY_EMAIL="%s"', $config->s('ca', true)->l('key_email', true)),
    sprintf('export KEY_OU="%s"', $config->s('ca', true)->l('key_ou', true)),
);
$varsFile = $easyRsaTargetConfigPath."/vars";
$varsContent = str_replace($search, $replace, file_get_contents($varsFile));
file_put_contents($varsFile, $varsContent);

$db = new PDO(
    $config->s('PdoStorage')->l('dsn'),
    $config->s('PdoStorage')->l('username', false),
    $config->s('PdoStorage')->l('password', false)
);

$db = new PdoStorage($db);

$e = new EasyRsa($easyRsaTargetConfigPath, $db);
$e->initCa();
