#!/usr/bin/php
<?php

require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\VPN\EasyRsa;
use fkooman\Ini\IniReader;
use fkooman\VPN\PdoStorage;
use fkooman\VPN\ConfigGenerator;

$iniReader = IniReader::fromFile(
    dirname(__DIR__).'/config/config.ini'
);

$commonName = 'server';

$easyRsaTargetConfigPath = $iniReader->v(['easyRsaConfigPath']);

$pdo = new PDO(
    $iniReader->v(['PdoStorage', 'dsn']),
    $iniReader->v(['PdoStorage', 'username', false]),
    $iniReader->v(['PdoStorage', 'password', false])
);

$pdoStorage = new PdoStorage($pdo);

$easyRsa = new EasyRsa($easyRsaTargetConfigPath, $pdoStorage);
$certKeyDh = $easyRsa->generateServerCert($commonName);
$tlsAuth = $easyRsa->getTlsAuthKey();

$configData = array(
    'cn' => $commonName,
    'ca' => $easyRsa->getCaCert(),
    'cert' => $certKeyDh['cert'],
    'key' => $certKeyDh['key'],
    'dh' => $certKeyDh['dh'],
    'ta' => $tlsAuth,
    'network' => $iniReader->v(['server', 'network']),
    'netmask' => $iniReader->v(['server', 'netmask']),
    'nameservers' => $iniReader->v(['server', 'nameservers']),
);
$configGenerator = new ConfigGenerator($configData);
echo $configGenerator->getConfig('server.twig');
