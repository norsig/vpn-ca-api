#!/usr/bin/php
<?php

require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\VPN\EasyRsa;
use fkooman\Config\Config;
use fkooman\VPN\PdoStorage;
use fkooman\VPN\ConfigGenerator;

$config = Config::fromIniFile(
    dirname(__DIR__)."/config/config.ini"
);

$commonName = "server";

$easyRsaTargetConfigPath = $config->getValue('easyRsaConfigPath', true);

$db = new PDO(
    $config->s('PdoStorage')->l('dsn'),
    $config->s('PdoStorage')->l('username', false),
    $config->s('PdoStorage')->l('password', false)
);

$db = new PdoStorage($db);

$easyRsa = new EasyRsa($easyRsaTargetConfigPath, $db);
$certKeyDh = $easyRsa->generateServerCert($commonName);

$configData = array(
    'cn' => $commonName,
    'ca' => $easyRsa->getCaCert(),
    'cert' => $certKeyDh['cert'],
    'key' => $certKeyDh['key'],
    'dh' => $certKeyDh['dh'],
    'network' => $config->s('server', true)->l('network', true),
    'netmask' => $config->s('server', true)->l('netmask', true),
    'nameservers' => $config->s('server', true)->s('nameservers', true)->toArray(),
);
$configGenerator = new ConfigGenerator($configData);
echo $configGenerator->getConfig('server.twig');
